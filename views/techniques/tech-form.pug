extends ../layouts/admin-layout.pug

block content
  .mb-6.flex.items-center.justify-between
    h1(class="text-2xl font-bold text-gray-900") #{pageTitle}
    a(href="/techniques/all" class="text-sm text-blue-600 hover:underline") ← Back to All Techniques

  if errorMessage
    p(class="mb-4 bg-red-50 text-red-800 px-4 py-2 rounded border border-red-200") #{errorMessage}

  form(action=formAction method="POST" class="bg-white rounded-xl shadow p-6 border border-gray-100 space-y-5")
    +csrfField()
    if formData && formData.techId
      input(type="hidden" name="techId" value=formData.techId)
    if formData && formData.updatedAt
      input(type="hidden" name="updatedAt" value=formData.updatedAt)

    // Title
    .flex.flex-col
      label(for="techTitle" class="text-sm font-medium text-gray-700") Title
      input#techTitle(
        type="text"
        name="techTitle"
        required
        value=(formData && formData.techTitle) || ''
        class=( (fieldErrors && fieldErrors.techTitle)
          ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 border-red-400"
          : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500")
        placeholder="e.g., Delayed Sword"
      )
      if fieldErrors && fieldErrors.techTitle
        p(class="text-xs text-red-600 mt-1") #{fieldErrors.techTitle}

    // Slug
    .flex.flex-col
      label(for="techSlug" class="text-sm font-medium text-gray-700") Slug
      input#techSlug(
        type="text"
        name="techSlug"
        required
        value=(formData && formData.techSlug) || ''
        class=( (fieldErrors && fieldErrors.techSlug)
          ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 border-red-400"
          : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500")
        placeholder="delayed-sword"
      )
      if fieldErrors && fieldErrors.techSlug
        p(class="text-xs text-red-600 mt-1") #{fieldErrors.techSlug}

    // Attack
    .flex.flex-col
      label(for="techAttack" class="text-sm font-medium text-gray-700") Attack
      input#techAttack(
        type="text"
        name="techAttack"
        required
        value=(formData && formData.techAttack) || ''
        class=( (fieldErrors && fieldErrors.techAttack)
          ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 border-red-400"
          : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500")
        placeholder="Right-hand lapel grab"
      )
      if fieldErrors && fieldErrors.techAttack
        p(class="text-xs text-red-600 mt-1") #{fieldErrors.techAttack}

    // Description (JSON)
    .flex.flex-col
      label(for="techDescription" class="text-sm font-medium text-gray-700") Description (JSON)
      textarea#techDescription(
        name="techDescription"
        rows="8"
        class=( (fieldErrors && fieldErrors.techDescription)
          ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 font-mono text-sm border-red-400"
          : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 font-mono text-sm")
        placeholder='{"steps":["...","..."],"notes":"..."}'
      ) #{ (formData && formData.techDescription) ? JSON.stringify(formData.techDescription, null, 2) : '' }
      if fieldErrors && fieldErrors.techDescription
        p(class="text-xs text-red-600 mt-1") #{fieldErrors.techDescription}

    // Technique Group
    .flex.flex-col
      label(for="techGroup" class="text-sm font-medium text-gray-700") Technique Group
      if techGroup && techGroup.length
        select#techGroup(
          name="techGroup"
          required
          class=( (fieldErrors && fieldErrors.techGroup)
            ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 border-red-400"
            : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500")
        )
          option(value="" disabled selected=!(formData && formData.techGroup)) Select an group type
          each g in techGroup
            option(
              value=g
              selected=(formData && formData.techGroup === g)
            ) #{g}
      else
        // fallback text input if constants weren't provided
        input#techGroup(
          type="text"
          name="techGroup"
          required
          value=(formData && formData.techGroup) || ''
          class=( (fieldErrors && fieldErrors.techGroup)
            ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 border-red-400"
            : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500")
          placeholder="e.g., Grab"
        )
      if fieldErrors && fieldErrors.techGroup
        p(class="text-xs text-red-600 mt-1") #{fieldErrors.techGroup}


    // Attack Angle
    .flex.flex-col
      label(for="techAttackAngle" class="text-sm font-medium text-gray-700") Attack Angle
      if techAttackAngle && techAttackAngle.length
        select#techAttackAngle(
          name="techAttackAngle"
          required
          class=( (fieldErrors && fieldErrors.techAttackAngle)
            ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 border-red-400"
            : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500")
        )
          option(value="" disabled selected=!(formData && formData.techAttackAngle)) Select an angle
          each angle in techAttackAngle
            option(
              value=angle
              selected=(formData && formData.techAttackAngle && formData.techAttackAngle === angle)
            ) #{angle}
      else
        input#techAttackAngle(
          type="text"
          name="techAttackAngle"
          required
          value=(formData && formData.techAttackAngle) || ''
          class="mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500"
          placeholder="e.g., 3:00"
        )

    // Notes
    .flex.flex-col
      label(for="techNotes" class="text-sm font-medium text-gray-700") Notes
      textarea#techNotes(
        name="techNotes"
        rows="5"
        class=( (fieldErrors && fieldErrors.techNotes)
          ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 border-red-400"
          : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500")
        placeholder="Instructor notes…"
      ) #{ (formData && formData.techNotes) || '' }
      if fieldErrors && fieldErrors.techNotes
        p(class="text-xs text-red-600 mt-1") #{fieldErrors.techNotes}

    // Related Form (optional)
    .flex.flex-col
      label(for="relatedForm" class="text-sm font-medium text-gray-700") Related Form (optional)
      input#relatedForm(
        type="text"
        name="relatedForm"
        value=(formData && formData.relatedForm) || ''
        class="mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500"
        placeholder="e.g., Short Form 2"
      )

    // Belt Color
    .flex.flex-col
      label(for="beltColor" class="text-sm font-medium text-gray-700") Belt Color
      if beltColor && beltColor.length
        select#beltColor(
          name="beltColor"
          required
          class=( (fieldErrors && fieldErrors.beltColor)
            ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 border-red-400"
            : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500")
        )
          option(value="" disabled selected=!(formData && formData.beltColor)) Select a belt
          each color in beltColor
            option(
              value=color
              selected=(formData && formData.beltColor === color)
            ) #{color}
      else
        input#beltColor(
          type="text"
          name="beltColor"
          required
          value=(formData && formData.beltColor) || ''
          class=( (fieldErrors && fieldErrors.beltColor)
            ? "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500 border-red-400"
            : "mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500")
          placeholder="Yellow / Orange / …"
        )
      if fieldErrors && fieldErrors.beltColor
        p(class="text-xs text-red-600 mt-1") #{fieldErrors.beltColor}

    // Video URL (optional)
    .flex.flex-col
      label(for="videoUrl" class="text-sm font-medium text-gray-700") Video URL (optional)
      input#videoUrl(
        type="url"
        name="videoUrl"
        value=(formData && formData.videoUrl) || ''
        class="mt-1 w-full rounded border-gray-300 focus:ring-2 focus:ring-blue-500"
        placeholder="https://…"
      )

    // Last Updated By (readonly if present)
    if formData && formData.lastUpdatedBy
      .flex.flex-col
        label(class="text-sm font-medium text-gray-700") Last Updated By
        input(type="text" readonly value=formData.lastUpdatedBy
          class="mt-1 w-full rounded border-gray-200 bg-gray-50 text-gray-600")

    // Actions
    .flex.items-center.gap-3.pt-2
      button(type="submit" class="inline-flex items-center px-4 py-2 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition") #{submitButtonText || 'Save Changes'}
      a(href="/techniques/all" class="text-sm text-gray-600 hover:underline") Cancel
